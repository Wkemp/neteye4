# NetEye Cluster: Icinga2 satellite services configuration

In the cluster, next to the icinga2-master service managed by the cluster software, an additional Icinga2 satellite can be configured as "worker" on the local node.
The configuration of the master zone is therefore extended by another zone, containing the Icinga2 satellites. You can enable one on each cluster node. Services may co-exists with icinga2-master service, using a different port.

Overview:
icinga2-master: managed by cluster service, relocates witin cluster, uses port 5665 for communication
icinga2: managed by local systemctl, provies monitoring on local node, uses port 5664 for communication

## Zoning architecture

zone: master
endpoints: icinga2-master

zone: satellite
endpoints: icinga2-node1, icinga2-node2, ... icinga2-nodeN
parent zone: master


# Generate certificates for each icinga2 satellite
Note: Generate and sign certificates where icinga2-master service is running!


## Certificate creation for satellite node

```
# cd /neteye/shared/icinga2/data/lib/icinga2/certs/
# export icinga_node_name="neteye4vm1.yourdomain.local"
# icinga2 pki new-cert --cn "${icinga_node_name}" --key "${icinga_node_name}.key" --cert "${icinga_node_name}.crt" --csr "${icinga_node_name}.csr"
# icinga2-master pki sign-csr --csr ${icinga_node_name}.csr --cert ${icinga_node_name}.crt
```


### Configuration sample for icinga2-master and icinga2

**Constants.conf for icinga2-master**
Path: /neteye/shared/icinga2/conf/icinga2/constants.conf
```
/**
 * This file defines global constants which can be used in
 * the other configuration files.
 */

/* The directory which contains the plugins from the Monitoring Plugins project. */
const PluginDir = "/usr/lib64/neteye/monitoring/plugins"

/* The directory which contains the Manubulon plugins.
 * Check the documentation, chapter "SNMP Manubulon Plugin Check Commands", for details.
 */
const ManubulonPluginDir = "/usr/lib64/neteye/monitoring/plugins"

/* The directory which you use to store additional plugins which ITL provides user contributed command definitions for.
 * Check the documentation, chapter "Plugins Contribution", for details.
 */
const PluginContribDir = "/neteye/shared/monitoring/plugins/"

/* Our local instance name. By default this is the server's hostname as returned by `hostname --fqdn`.
 * This should be the common name from the API certificate.
 */
const NodeName = "neteye4.mydomain.local"

/* Our local zone name. */
const ZoneName = "master"

/* Secret key for remote node tickets */
const TicketSalt = "ca57c90f3fb26677a7101232b3bfb5d5"
```


**Constants.conf for icinga2**
Path: /neteye/local/icinga2/conf/icinga2/constants.conf
```
/**
 * This file defines global constants which can be used in
 * the other configuration files.
 */

/* The directory which contains the plugins from the Monitoring Plugins project. */
const PluginDir = "/usr/lib64/neteye/monitoring/plugins"

/* The directory which contains the Manubulon plugins.
 * Check the documentation, chapter "SNMP Manubulon Plugin Check Commands", for details.
 */
const ManubulonPluginDir = "/usr/lib64/neteye/monitoring/plugins"

/* The directory which you use to store additional plugins which ITL provides user contributed command definitions for.
 * Check the documentation, chapter "Plugins Contribution", for details.
 */
const PluginContribDir = "/neteye/shared/monitoring/plugins/"

/* Our local instance name. By default this is the server's hostname as returned by `hostname --fqdn`.
 * This should be the common name from the API certificate.
 */
const NodeName = "neteye4vm1.mydomain.local"

/* Our local zone name. */
const ZoneName = "cluster-satellite"

/* Secret key for remote node tickets */
const TicketSalt = ""
```


**Zones.conf valid for both icinga2-master and icinga2**
Path: /neteye/local/icinga2/conf/icinga2/zones.conf
```
/*
 * Generated by Icinga 2 node setup commands
 * on 2019-02-19 14:19:43 +0000
 */

#object Endpoint "icinga2-master.neteyelocal" {
#}
object Endpoint "neteye4.mydomain.local" {
}

object Zone "master" {
        endpoints = [ "neteye4.mydomain.local" ]
}

object Zone "global-templates" {
        global = true
}

object Zone "director-global" {
        global = true
}


include_recursive "zones.d"
```
Provide satellite zone configuration in zones.d/ include directory:
Path: /neteye/shared/icinga2/conf/icinga2/zones.d/cluster.conf

```
object Endpoint "neteye4vm1.mydomain.local" {
        host = "neteye4vm1.mydomain.local"
        port = 5664
}

object Endpoint "neteye4vm2.mydomain.local" {
        host = "neteye4vm2.mydomain.local"
        port = 5664
}

object Zone "cluster-satellite" {
        endpoints = [ "neteye4vm1.mydomain.local", "neteye4vm2.mydomain.local" ]
        parent = "master"
    }
```


[<<< Back to documentation overview <<<](./README.md)
